pipeline {
  agent {
    docker {
      image 'python:3.11-slim'
      // only keep the host alias so the build container can reach MLflow
      args '--add-host=host.docker.internal:host-gateway'
    }
  }
  environment {
    PYTHONUNBUFFERED = '1'
    MLFLOW_TRACKING_URI = 'http://host.docker.internal:5000'
    // cache lives under the workspace, which is already volume-shared
    PIP_CACHE_DIR = "${env.WORKSPACE}/.pip-cache"
  }
  options { skipDefaultCheckout(true) }
  stages {
    stage('Checkout') {
      steps {
        deleteDir()
        checkout scm
      }
    }
    stage('Setup Python') {
      steps {
        sh '''
          python -m pip install --upgrade pip setuptools wheel
          pip install -r requirements.txt
        '''
      }
    }
    stage('Train Sample Model') {
      steps { sh 'python scripts/train_sample_model.py' }
    }
    stage('Validate (Policy Gates)') {
      steps {
        sh '''
          export PYTHONPATH=src
          python src/runner.py \
            --model-path models/iris_logreg.pkl \
            --data-path data/iris.csv \
            --suite f1,latency_p95,pii \
            --policy policy.yaml
        '''
      }
    }
  }
  post {
    always {
      // ensure we still have a node/workspace context
      archiveArtifacts artifacts: 'mlruns/**/*, **/report.txt', allowEmptyArchive: true
    }
  }
}

